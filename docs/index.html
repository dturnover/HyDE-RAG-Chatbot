<!doctype html>
<html lang="en">
<head>
    </head>
<body class="bg-bg-light min-h-screen p-4 sm:p-6 font-sans">
    <script>
    const API = "https://llm-api-demo-5qz1.onrender.com";

    const log = document.getElementById("log");
    const msgEl = document.getElementById("msg");
    const healthBtn = document.getElementById("health");
    const clearBtn = document.getElementById("clear");
    const sendBtn = document.getElementById("send");
    const streamBox = document.getElementById("stream");

    const getSID = () => localStorage.getItem("sid");
    const setSID = (sid) => localStorage.setItem("sid", sid);

    // ... addLine, addDbg, healthBtn.onclick, clearBtn.onclick are unchanged ...
    
    sendBtn.onclick = async () => {
        const text = (msgEl.value || "").trim();
        if (!text) return;
        addLine("you", "You", text);
        msgEl.value = "";

        // ★★★ MODIFIED PAYLOAD ★★★
        const payload = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // Send the SID in the body, not a header
            body: JSON.stringify({ message: text, sid: getSID() }),
        };

        const useStream = !!streamBox.checked;
        if (!useStream) {
            // Non-streaming logic updated as well
            try {
                const r = await fetch(`${API}/chat`, payload);
                const j = await r.json();
                const responseText = j?.text ?? "[No response or response key mismatch]";
                addLine("bot", "Bot", responseText);
                if (j?.sid) setSID(j.sid); // Update SID if server sends a new one
            } catch (e) {
                addLine("bot", "Bot", "[Network Error] " + (e?.message || e));
            }
            return;
        }

        // Streaming logic using the proven method
        try {
            const response = await fetch(`${API}/chat`, payload);
            if (!response.body) throw new Error("Response body is missing.");
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            const { line, msgSpan } = addLine("bot", "Bot", "");
            const cursor = document.createElement("span");
            cursor.className = "cursor inline-block w-1.5 h-4 bg-gray-500 align-middle ml-0.5 animate-pulse rounded-sm";
            line.appendChild(cursor);
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split("\n\n");
                buffer = lines.pop();

                for (const line of lines) {
                    if (!line.startsWith("data:") && !line.startsWith("event:")) continue;

                    const eventMatch = line.match(/^event: (.*)$/m);
                    const dataMatch = line.match(/^data: (.*)$/m);

                    if (eventMatch && dataMatch) {
                        const eventName = eventMatch[1];
                        const data = dataMatch[1];
                        
                        // ★★★ LISTEN FOR 'start' EVENT ★★★
                        if (eventName === 'start') {
                            const obj = JSON.parse(data);
                            if (obj.sid) setSID(obj.sid); // Save the session ID from the server
                        }
                    } else if (dataMatch) {
                        const data = dataMatch[1];
                        if (data === "[END]") continue;
                        try {
                            const obj = JSON.parse(data);
                            if (obj.text) { fullText += obj.text; msgSpan.textContent = fullText; }
                            if (obj.footer) { fullText += obj.footer; msgSpan.textContent = fullText; }
                        } catch (e) { /* ignore */ }
                    }
                }
                log.scrollTop = log.scrollHeight;
            }
            cursor.remove();
        } catch (e) {
            addLine("bot", "Bot", "[Stream Error] " + (e?.message || e));
        }
    };
    
    // ... other functions and event listeners ...
</script>
</body>
</html>