<!doctype html>
<script>
    const API = "YOUR_RENDER_URL_HERE"; // Make sure this is correct

    // ... element consts and UI functions (addLine, addDbg) are the same ...

    // ★★★ NEW: Client-side history management ★★★
    let conversationHistory = [];

    sendBtn.onclick = async () => {
        const text = (msgEl.value || "").trim();
        if (!text) return;
        
        addLine("you", "You", text);
        msgEl.value = "";

        // Add user message to our local history
        conversationHistory.push({ role: "user", content: text });

        const payload = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // Send the new message AND the entire history
            body: JSON.stringify({
                message: text,
                history: conversationHistory.slice(0, -1) // Send history *before* the current message
            }),
        };

        try {
            const response = await fetch(`${API}/chat`, payload);
            if (!response.body) throw new Error("Response body is missing.");
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";
            let fullBotResponse = "";

            const { line, msgSpan } = addLine("bot", "Bot", "");
            // ... cursor logic is the same ...

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split("\n\n");
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.startsWith("data: ")) {
                        const data = line.substring(6).trim();
                        if (data === "[END]") continue;
                        try {
                            const obj = JSON.parse(data);
                            if (obj.text) {
                                fullBotResponse += obj.text;
                                msgSpan.textContent = fullBotResponse;
                            }
                        } catch (e) { /* ignore */ }
                    }
                }
                log.scrollTop = log.scrollHeight;
            }
            // Add the final bot response to our local history
            conversationHistory.push({ role: "assistant", content: fullBotResponse });
            // ... remove cursor ...
        } catch (e) {
            addLine("bot", "Bot", "[Stream Error] " + (e?.message || e));
        }
    };
    
    clearBtn.onclick = () => {
        log.innerHTML = "";
        conversationHistory = []; // Clear the history array too
    };

    // ... other event listeners ...
</script>
</body>
</html>