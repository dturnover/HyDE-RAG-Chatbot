<!doctype html>
<script>
    const API = "https://llm-api-demo-5qz1.onrender.com";
    // ... all consts and helper functions up to sendBtn.onclick are unchanged ...

    sendBtn.onclick = async () => {
        const text = (msgEl.value || "").trim();
        if (!text) return;
        
        addLine("you", "You", text);
        msgEl.value = "";
        
        conversationHistory.push({ role: "user", content: text });

        const payload = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                message: text,
                history: conversationHistory.slice(0, -1)
            }),
        };

        try {
            const response = await fetch(`${API}/chat`, payload);
            if (!response.body) throw new Error("Response body is missing.");
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";
            let fullBotResponse = "";

            const { line, msgSpan } = addLine("bot", "Bot", "");
            const cursor = document.createElement("span");
            cursor.className = "cursor inline-block w-1.5 h-4 bg-gray-500 align-middle ml-0.5 animate-pulse rounded-sm";
            line.appendChild(cursor);

            const streamReader = async () => {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split("\n\n");
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            const data = line.substring(6).trim();
                            if (data === "[END]") continue;
                            try {
                                const obj = JSON.parse(data);
                                if (obj.text) {
                                    // ★★★ FIX 2: SLOWER STREAMING ★★★
                                    // Process each character with a small delay
                                    for (const char of obj.text) {
                                        fullBotResponse += char;
                                        msgSpan.textContent = fullBotResponse;
                                        await new Promise(resolve => setTimeout(resolve, 15)); // 15ms delay
                                    }
                                }
                            } catch (e) { /* ignore */ }
                        }
                    }
                    log.scrollTop = log.scrollHeight;
                }
            };

            await streamReader(); // Await the streaming process

            cursor.remove();
            if (fullBotResponse) {
                conversationHistory.push({ role: "assistant", content: fullBotResponse });
            }

        } catch (e) {
            addLine("bot", "Bot", "[Stream Error] " + (e?.message || e));
            conversationHistory.pop();
        }
    };
    
    // ... rest of the script is unchanged ...
</script>
</body>
</html>