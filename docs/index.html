<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Fight Chaplain Chat</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple scrollbar styling */
        #log::-webkit-scrollbar { width: 8px; }
        #log::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        #log::-webkit-scrollbar-track { background-color: #f1f5f9; }
        
        /* The pulsing cursor for the bot */
        .cursor {
            width: 10px;
            height: 1.125rem; /* 18px */
            background-color: #9ca3af;
            display: inline-block;
            vertical-align: middle;
            margin-left: 2px;
            border-radius: 2px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
    <script>
        // Set default font to match client's site
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'Arial', 'sans-serif'] },
                }
            }
        }
    </script>
</head>
<body class="font-sans">
    
    <div class="w-full max-w-3xl mx-auto">
        
        <div id="log" class="border border-gray-300 bg-white rounded-xl p-4 md:p-5 min-h-80 max-h-[70vh] overflow-y-auto mb-6 shadow-inner">
            </div>

        <div class="flex gap-2 items-end">
            <textarea id="msg" rows="3" placeholder="Type your message... (e.g., I'm feeling stressed)" class="flex-grow w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 resize-none text-gray-700"></textarea>
            
            <button id="send" class="h-14 w-20 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-lg flex items-center justify-center">Send</button>
        </div>
    </div>

<script>
    // ### IMPORTANT: Update this URL to your Render backend ###
    const API = "https://fight-chaplain.onrender.com"; // <-- PUT YOUR URL HERE

    const log = document.getElementById("log");
    const msgEl = document.getElementById("msg");
    const sendBtn = document.getElementById("send");

    let conversationHistory = [];

    /**
     * Adds a "User" message bubble to the chat log.
     */
    const addUserMessage = (text) => {
        const bubble = document.createElement("div");
        bubble.className = "flex justify-end mb-3";
        bubble.innerHTML = `
            <div class="bg-blue-600 text-white rounded-lg py-2 px-4 max-w-[80%] whitespace-pre-wrap">
                ${text}
            </div>
        `;
        log.appendChild(bubble);
        log.scrollTop = log.scrollHeight;
    };

    /**
     * Adds a "Bot" message bubble to the chat log and returns the
     * span element where text can be streamed.
     */
    const addBotMessage = () => {
        const bubble = document.createElement("div");
        bubble.className = "flex justify-start mb-3";
        bubble.innerHTML = `
            <div class="bg-gray-100 text-gray-800 rounded-lg py-2 px-4 max-w-[80%] whitespace-pre-wrap">
                <span class="msg-content"></span>
                <span class="cursor"></span>
            </div>
        `;
        log.appendChild(bubble);
        log.scrollTop = log.scrollHeight;
        
        const msgSpan = bubble.querySelector(".msg-content");
        const cursor = bubble.querySelector(".cursor");
        
        return { msgSpan, cursor };
    };

    /**
     * Handles the Send button click event
     */
    const sendMessage = async () => {
        const text = (msgEl.value || "").trim();
        if (!text) return;

        // 1. Add the user's message to the UI
        addUserMessage(text);
        msgEl.value = "";
        
        // 2. Add to conversation history
        conversationHistory.push({ role: "user", content: text });

        // 3. Prepare payload for the backend
        const payload = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                message: text,
                // Send all history *except* the latest message
                history: conversationHistory.slice(0, -1) 
            }),
        };

        try {
            // 4. Create the bot message bubble and get its text span
            const { msgSpan, cursor } = addBotMessage();
            let fullBotResponse = "";

            // 5. Call the backend API
            const response = await fetch(`${API}/chat`, payload);
            if (!response.body) throw new Error("Response body is missing.");
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            // 6. Read the stream from the backend
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split("\n\n");
                buffer = lines.pop(); // Keep any partial line for the next loop

                for (const line of lines) {
                    if (line.startsWith("data: ")) {
                        const data = line.substring(6).trim();
                        if (data === "[END]") continue;
                        
                        try {
                            const obj = JSON.parse(data);
                            if (obj.text) {
                                // --- THIS IS THE FIXED STREAM LOGIC ---
                                // Append the new chunk and update the UI
                                fullBotResponse += obj.text;
                                msgSpan.textContent = fullBotResponse;
                                log.scrollTop = log.scrollHeight;
                            }
                        } catch (e) {
                            console.error("Failed to parse stream data:", data, e);
                        }
                    }
                }
            } // end while

            // 7. Stream is finished, remove the cursor
            cursor.remove();
            
            // 8. Add the final, full response to history
            if (fullBotResponse) {
                conversationHistory.push({ role: "assistant", content: fullBotResponse });
            }

        } catch (e) {
            // Handle network errors
            const { msgSpan, cursor } = addBotMessage();
            msgSpan.textContent = "[Error] " + (e?.message || "Could not connect to the server.");
            cursor.remove();
            conversationHistory.pop(); // Remove the user message that failed
        }
    };

    sendBtn.onclick = sendMessage;
    msgEl.addEventListener("keydown", (e) => {
        // Send on Ctrl+Enter or Cmd+Enter
        if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
            sendMessage();
        }
    });

    // Add the initial "onboarding" message from the bot
    const addOnboardingMessage = () => {
        const bubble = document.createElement("div");
        bubble.className = "flex justify-start mb-3";
        bubble.innerHTML = `
            <div class="bg-gray-100 text-gray-800 rounded-lg py-2 px-4 max-w-[80%] whitespace-pre-wrap">
                Thank you for logging in! What would you like to talk about?
            </div>
        `;
        log.appendChild(bubble);
        log.scrollTop = log.scrollHeight;
    };

    // Show the first message when the page loads
    addOnboardingMessage();
    
    // Ping the backend on load to "wake it up"
    (async () => { try { await fetch(`${API}/diag`); } catch {} })();
</script>
</body>
</html>