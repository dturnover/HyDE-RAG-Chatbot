<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>LLM API Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
body{font-family:system-ui,Arial,sans-serif;max-width:820px;margin:24px auto;padding:0 12px}
#log{border:1px solid #ddd;border-radius:12px;padding:12px;min-height:220px}
.row{display:flex;gap:8px;align-items:flex-start;margin:10px 0}
textarea{width:100%;padding:10px}
button{padding:8px 14px}
.tiny{font-size:12px;color:#666}
.line{white-space:pre-wrap;margin:2px 0}
.role{color:#555;font-weight:600;margin-right:6px}
.bot .role{color:#0b5}
.dbg{color:#888;font-style:italic}
.cursor{display:inline-block;width:6px;background:#bbb;animation:blink 1s step-end infinite}
@keyframes blink{50%{background:transparent}}
</style>
</head>
<body>
  <h2>LLM API Demo</h2>
  <div class="row">
    <button id="health">Health</button>
    <label class="tiny"><input type="checkbox" id="stream" checked> stream</label>
    <button id="clear">Clear</button>
  </div>
  <div id="log"></div>
  <div class="row">
    <textarea id="msg" rows="2" placeholder="Type your message..."></textarea>
    <button id="send">Send</button>
  </div>
<script>
const API = "https://llm-api-demo-5qz1.onrender.com";
const log = document.getElementById("log");
const msgEl = document.getElementById("msg");
const healthBtn = document.getElementById("health");
const clearBtn = document.getElementById("clear");
const sendBtn = document.getElementById("send");
const streamBox = document.getElementById("stream");

const getSID = () => {
  let sid = localStorage.getItem("sid");
  if (!sid) { sid = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2); localStorage.setItem("sid", sid); }
  return sid;
};

const addLine = (cls, role, text="") => {
  const line = document.createElement("div");
  line.className = `line ${cls}`;
  const r = document.createElement("span"); r.className = "role"; r.textContent = role + ":";
  const m = document.createElement("span"); m.className = "msg"; m.textContent = " " + text;
  line.appendChild(r); line.appendChild(m); log.appendChild(line); log.scrollTop = log.scrollHeight;
  return { line, msgSpan: m };
};
const addDbg = (t) => { const d=document.createElement("div"); d.className="line dbg"; d.textContent=`dbg: ${t}`; log.appendChild(d); log.scrollTop=log.scrollHeight; };

let live=null;
const startLive=()=>{ const {line,msgSpan}=addLine("bot","Bot",""); const c=document.createElement("span"); c.className="cursor"; c.textContent=" "; line.appendChild(c); live={line,msgSpan,c,buf:""}; };
const pushLive=(t)=>{ if(!live) startLive(); live.buf+=t; live.msgSpan.textContent=" "+live.buf; log.scrollTop=log.scrollHeight; };
const endLive=()=>{ if(!live) return; live.line.removeChild(live.c); live=null; };

healthBtn.onclick = async () => {
  try { const r = await fetch(`${API}/health`); addDbg(`health: ${(await r.text()).trim()}`); } catch(e){ addDbg(`health error: ${e?.message||e}`); }
};
clearBtn.onclick = () => { log.textContent = ""; };

sendBtn.onclick = async () => {
  const text = (msgEl.value||"").trim(); if(!text) return;
  addLine("", "You", text); msgEl.value="";
  const useStream = !!streamBox.checked;
  if(!useStream){
    try{
      const r = await fetch(`${API}/chat`, {
        method:"POST",
        headers:{"Content-Type":"application/json","X-Session-Id":getSID()},
        body:JSON.stringify({message:text}),
        credentials:"include"
      });
      const j = await r.json(); if(j?.sid) localStorage.setItem("sid", j.sid);
      addLine("bot","Bot", j?.response ?? "[no response]");
    }catch(e){ addLine("bot","Bot", "[network error] "+(e?.message||e)); }
    return;
  }
  const tryStream=(attempt=1)=>{
    startLive();
    const url = `${API}/chat_sse?q=${encodeURIComponent(text)}&sid=${encodeURIComponent(getSID())}&_=${Date.now()}`;
    const es = new EventSource(url);
    let gotAny=false;
    es.onopen = () => addDbg("[sse opened]");
    es.onmessage = (ev) => {
      if(!ev.data) return;
      try{ const obj=JSON.parse(ev.data); if(obj.text){ pushLive(obj.text); gotAny=true; } else pushLive(ev.data+"\n"); }
      catch{ pushLive(ev.data+"\n"); }
    };
    es.addEventListener("done",(ev)=>{ try{ const j=ev.data?JSON.parse(ev.data):{}; if(j?.sid) localStorage.setItem("sid", j.sid);}catch{} addDbg("[done]"); es.close(); endLive(); });
    es.addEventListener("ping",()=>{});
    es.onerror=()=>{ es.close(); if(!gotAny && attempt===1){ addDbg("[sse retry]"); endLive(); setTimeout(()=>tryStream(2),800); } else { addLine("bot","Bot","[stream error]"); endLive(); } };
    setTimeout(()=>{ try{es.close(); endLive();}catch{} }, 90000);
  };
  tryStream();
};
(async()=>{ try{ await fetch(`${API}/health`, {mode:"no-cors"}); }catch{} })();
msgEl.addEventListener("keydown",(e)=>{ if(e.key==="Enter"&&(e.metaKey||e.ctrlKey)) sendBtn.onclick(); });
</script>
</body>
</html>
